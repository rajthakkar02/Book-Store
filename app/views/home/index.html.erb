<h1>Books Store</h1>
<% if user_signed_in? && current_user.seller? %>
  <nav style="display: flex; justify-content: space-between; align-items: center; background-color: #333; padding: 10px;">
    <h2 style="margin-top: 20px; color: white">Welcome Seller, <%= current_user.name %></h2>
    <div>
      <%= button_to 'Sign out', destroy_user_session_path, method: :delete, style: "margin-right: 10px; padding: 10px 20px; background-color: #b00; color: white; border: none; border-radius: 5px;" %>
      <br>
      <%= link_to 'Add Author', authors_path, method: :get, style: "margin-bottom: 10px; padding: 10px 20px; background-color: #007bff; color: white; text-decoration: none; border-radius: 5px; text-align: center;" %>
      <%= link_to 'Add Book', books_path, method: :get, style: "margin-bottom: 10px; padding: 10px 20px; background-color: #007bff; color: white; text-decoration: none; border-radius: 5px; text-align: center;" %>
      <%= link_to 'Ordered Book', orders_path, method: :get, style: " margin-bottom: 10px; padding: 10px 20px; background-color: #007bff; color: white; text-decoration: none; border-radius: 5px; text-align: center;" %>
    </div>
  </nav>

  <h2 style="margin-left: 20px; font-weight: bold;">Total bookings of books by author for current week</h2>
  <% 
    data_week = Author.where(user_id: current_user.id).map do |author|
    ["#{author[:name]}", author.total_bookings_current_week]
  end
  %>
  <%= bar_chart data_week, colors: ["#b00", "#666"], height: '500px' %>

  <h2 style="margin-left: 20px; font-weight: bold;">Total bookings of books by author for current month</h2>
  <% 
    data_month = Author.where(user_id: current_user.id).map do |author|
    ["#{author[:name]}", author.total_bookings_current_month]
  end
  %>
  <%= bar_chart data_month, colors: ["#b00", "#666"], height: '500px' %>

  <h2 style="margin-left: 20px; font-weight: bold;">Total bookings of books by author for current year</h2>
  <% 
    data_year = Author.where(user_id: current_user.id).map do |author|
    ["#{author[:name]}", author.total_bookings_current_year]
  end
  %>
  <%= bar_chart data_year, colors: ["#b00", "#666"], height: '500px' %>
  <h2 style="margin-left: 20px; font-weight: bold;">Total Orders by Week</h2>
  <div id="chart-week">
    <%= line_chart @bookings_by_week, xtitle: "Week", ytitle: "Order Count" %>
  </div>
  <h2 style="margin-left: 20px; font-weight: bold;">Total Orders by Month</h2>
  <div id="chart-month">
    <%= line_chart @bookings_by_month, xtitle: "Month", ytitle: "Order Count" %>
  </div>
  <h2 style="margin-left: 20px; font-weight: bold;">Most Popular books based on Orders</h2>
  <div id="pie-chart-order">
    <%= pie_chart @popular_book %>
  </div>
  <h2 style="margin-left: 20px; font-weight: bold;">Most Popular books based on Rating</h2>
  <div id="pie-chart-order">
    <%= pie_chart @popular_rating %>
  </div>
<% elsif user_signed_in? && !current_user.seller? %>
  <nav style="display: flex; justify-content: space-between; align-items: center; background-color: #333; padding: 10px;">
    <h2 style="color: white;">Welcome Home, <%= current_user.name %></h2>
    <div>
      <%= button_to 'Sign out', destroy_user_session_path, method: :delete, style: "margin-right: 10px; padding: 10px 20px; color: white; border: none; border-radius: 5px;" %>
      <br>
      <%= button_to "Order History", orders_path, method: :get, style: "margin-right: 10px; padding: 10px 20px;  color: white; border: none; border-radius: 5px;" %>
      <br>
      <%= button_to "Cart", cart_path, method: :get, style: "padding: 10px 20px; color: white; border: none; border-radius: 5px;" %>
    </div>
  </nav>
  <br>
  <%= search_form_for @q, url: root_path, method: :get do |f| %>
    <div style="margin-bottom: 10px;">
      <%= f.label :book_name_cont, "Search for books:", style: "margin-right: 10px;" %>
      <%= f.search_field :book_name_cont, style: "padding: 5px; border-radius: 5px; border: 1px solid #ccc;" %>
    </div>
    <div style="margin-bottom: 10px;">
      <%= f.label :author_name_cont, "Filter by Author:", style: "margin-right: 10px;" %>
      <%= f.select :author_name_cont, Author.all.map { |author| [author.name] }, include_blank: 'Select Author', style: "padding: 5px; border-radius: 5px; border: 1px solid #ccc;" %>
    </div>
    <div style="margin-bottom: 10px;">
      <%= f.label :user_name_eq, "Filter by Seller:", style: "margin-right: 10px;" %>
      <%= f.select :user_name_eq, User.where(seller: 1).map { |user| [user.name] }, include_blank: 'Select Seller', style: "padding: 5px; border-radius: 5px; border: 1px solid #ccc;" %>
    </div>
    <%= f.submit "Search", style: "padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px;" %>
    <%= link_to "Clear Search", request.path, class: "cancel-button", style: "padding: 10px 20px; background-color: #b00; color: white; border: none; border-radius: 5px; text-decoration: none; margin-left: 10px;" %>
  <% end %>
  <% if @books.empty? %>
    <p style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: bold; font-size: x-large">No data found.</p>
  <% end %>
  <br>
  <br>
  <div style="display: flex; flex-direction: row; flex-wrap: wrap;  justify-content: center; gap: 30px; margin-bottom: 20px">
    <% @books.all.each do |book| %>
      <% if book.quantity > 0 %>
        <div style="border: 1px solid #ccc; padding: 20px; margin-bottom: 30px; width: 300px; text-align: center;">
          <% if book.image.attached? %>
            <img src="<%= url_for(book.image) %>" alt="<%= book.book_name %> cover" style="width: 150px; height: auto; margin-bottom: 10px;">
          <% end %>
          <h2><strong><%= book.book_name %></strong></h2>
          <p><%= book.author.name %></p>
          <p><%= book.user.name %></p>
          <p>Price: ₹<%= book.price %></p>
          <%= button_to "Add to Cart", add_to_cart_path(book_id: book.id), method: :post, id: "add-cart", style: "margin-top: 10px; padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px;" %>
          <br>
          <%= button_to "Show Details", book, method: :get, style: "margin-top: 10px; padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px;" %>
          <br>
        </div>
      <% end %>
    <% end %>
  </div>
<% else %>
  <h1>Home</h1>
  <%= button_to 'Sign in', new_user_session_path, style: "margin-bottom: 20px; padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px;" %>
  <div style="display: flex; flex-direction: row; flex-wrap: wrap;  justify-content: center; gap: 30px; margin-bottom: 20px">
    <% @books.all.each do |book| %>
      <% if book.quantity > 0 %>
        <div style="border: 1px solid #ccc; padding: 20px; margin-bottom: 30px; width: 300px; text-align: center;">
          <% if book.image.attached? %>
            <img src="<%= url_for(book.image) %>" alt="<%= book.book_name %> cover" style="width: 150px; height: auto; margin-bottom: 10px;">
          <% end %>
          <h2><strong><%= book.book_name %></strong></h2>
          <p><%= book.author.name %></p>
          <p><%= book.user.name %></p>
          <p>Price: ₹<%= book.price %></p>
          <%= button_to "Add to Cart", new_user_session_path , method: :post, id: "add-cart", style: "margin-top: 10px; padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px;" %>
          <br>
          <%= button_to "Show Details", book, method: :get, style: "margin-top: 10px; padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px;" %>
          <br>
        </div>
      <% end %>
    <% end %>
  </div>
<% end %>
